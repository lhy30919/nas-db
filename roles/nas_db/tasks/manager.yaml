---
# roles/nas_db/tasks/manager.yaml
# MHA Manager 서버(10.4.4.11) 설정

- name: 호스트네임 설정
  ansible.builtin.hostname:
    name: mha-manager
    use: systemd

- name: /etc/hostname 파일 생성
  ansible.builtin.copy:
    content: "mha-manager\n"
    dest: /etc/hostname
    owner: root
    group: root
    mode: '0644'

- name: /etc/hosts 설정
  ansible.builtin.copy:
    content: |
      127.0.0.1   localhost
      ::1         localhost
      10.4.4.11 mha-manager
      10.4.4.12 db-master
      10.4.4.13 db-slave
    dest: /etc/hosts
    owner: root
    group: root
    mode: '0644'

- name: EPEL 저장소 설치
  ansible.builtin.dnf:
    name: epel-release
    state: present

- name: CRB 저장소 활성화
  community.general.ini_file:
    path: /etc/yum.repos.d/centos.repo
    section: crb
    option: enabled
    value: "1"
    no_extra_spaces: yes

- name: DNF 캐시 업데이트
  ansible.builtin.dnf:
    update_cache: yes

- name: MHA 필수 패키지 설치
  ansible.builtin.dnf:
    name:
      - perl
      - perl-DBI
      - perl-DBD-MySQL
      - perl-Config-Tiny
      - perl-Time-HiRes
      - perl-Log-Dispatch
      - perl-Parallel-ForkManager
      - perl-Module-Install
      - perl-JSON
      - openssh-clients
      - git
      - make
      - mysql
    state: present

- name: 소스 디렉토리 생성
  ansible.builtin.file:
    path: /home/ansible-admin/src
    state: directory
    owner: ansible-admin
    group: ansible-admin
    mode: '0755'

- name: MHA Node 저장소 클론
  ansible.builtin.git:
    repo: https://github.com/yoshinorim/mha4mysql-node.git
    dest: /home/ansible-admin/src/mha4mysql-node
    update: no
  become_user: ansible-admin

- name: MHA Node Makefile 존재 확인
  ansible.builtin.stat:
    path: /home/ansible-admin/src/mha4mysql-node/Makefile
  register: node_makefile_stat

- name: MHA Node Makefile 생성
  ansible.builtin.shell:
    cmd: perl Makefile.PL --installdirs site
    chdir: /home/ansible-admin/src/mha4mysql-node
  become_user: ansible-admin
  when: not node_makefile_stat.stat.exists

- name: MHA Node 빌드
  ansible.builtin.make:
    chdir: /home/ansible-admin/src/mha4mysql-node
  become_user: ansible-admin

- name: MHA Node 설치
  ansible.builtin.make:
    chdir: /home/ansible-admin/src/mha4mysql-node
    target: install

- name: MHA Manager 저장소 클론
  ansible.builtin.git:
    repo: https://github.com/yoshinorim/mha4mysql-manager.git
    dest: /home/ansible-admin/src/mha4mysql-manager
    update: no
  become_user: ansible-admin

- name: MHA Manager Makefile 존재 확인
  ansible.builtin.stat:
    path: /home/ansible-admin/src/mha4mysql-manager/Makefile
  register: manager_makefile_stat

- name: MHA Manager Makefile 생성
  ansible.builtin.shell:
    cmd: perl Makefile.PL --installdirs site
    chdir: /home/ansible-admin/src/mha4mysql-manager
  become_user: ansible-admin
  when: not manager_makefile_stat.stat.exists

- name: MHA Manager 빌드
  ansible.builtin.make:
    chdir: /home/ansible-admin/src/mha4mysql-manager
  become_user: ansible-admin

- name: MHA Manager 설치
  ansible.builtin.make:
    chdir: /home/ansible-admin/src/mha4mysql-manager
    target: install

- name: MHA 설정 디렉토리 생성
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: ansible-admin
    group: ansible-admin
    mode: '0755'
  loop:
    - /etc/mha
    - /var/log/mha
    - /var/log/mha/app1

- name: .my.cnf 파일 생성
  ansible.builtin.copy:
    content: |
      [client]
      user=mha
      password=mhapass
    dest: /home/ansible-admin/.my.cnf
    owner: ansible-admin
    group: ansible-admin
    mode: '0600'

- name: MHA 설정 파일 생성
  ansible.builtin.copy:
    content: |
      [server default]
      user=mha
      password=mhapass
      ssh_user=ansible-admin
      repl_user=repl
      repl_password=replpass
      
      manager_workdir=/var/log/mha/app1
      manager_log=/var/log/mha/app1/manager.log
      remote_workdir=/var/log/mha/app1
      
      ping_interval=3
      master_binlog_dir=/mnt/new_disk/mysql
      secondary_check_script=masterha_secondary_check -s 10.4.4.12 -s 10.4.4.13
      master_ip_failover_script=/usr/local/bin/master_ip_failover.sh
      
      [server1]
      hostname=10.4.4.12
      port=3306
      candidate_master=1
      check_repl_delay=0
      
      [server2]
      hostname=10.4.4.13
      port=3306
      candidate_master=1
      check_repl_delay=0
    dest: /etc/mha/app1.cnf
    owner: ansible-admin
    group: ansible-admin
    mode: '0644'

- name: VIP Failover 스크립트 생성
  ansible.builtin.copy:
    content: |
      #!/bin/bash
      
      VIP="10.4.4.100/24"
      LOGFILE="/var/log/mha/vip_failover.log"
      RECOVERY_SCRIPT="/usr/local/bin/mha_auto_recovery.sh"
      mkdir -p /var/log/mha
      
      log() {
          echo "$(date '+%Y-%m-%d %H:%M:%S') - $*" >> "$LOGFILE"
      }
      
      command=""
      orig_master_host=""
      new_master_host=""
      ssh_user="ansible-admin"
      
      while [[ $# -gt 0 ]]; do
          case $1 in
              --command=*) command="${1#*=}" ;;
              --orig_master_host=*) orig_master_host="${1#*=}" ;;
              --new_master_host=*) new_master_host="${1#*=}" ;;
              --ssh_user=*) ssh_user="${1#*=}" ;;
          esac
          shift
      done
      
      log "=== Command: $command, Orig: $orig_master_host, New: $new_master_host ==="
      
      case "$command" in
          stop|stopssh)
              log "Removing VIP from $orig_master_host"
              IFACE=$(ssh -o StrictHostKeyChecking=no ${ssh_user}@${orig_master_host} "ip route | awk '/default/ {print \$5}'")
              ssh -o StrictHostKeyChecking=no ${ssh_user}@${orig_master_host} \
                  "sudo /usr/sbin/ip addr del $VIP dev $IFACE 2>/dev/null || true"
              log "VIP removed from $orig_master_host"
              exit 0
              ;;
          start)
              log "Adding VIP to $new_master_host"
              IFACE=$(ssh -o StrictHostKeyChecking=no ${ssh_user}@${new_master_host} "ip route | awk '/default/ {print \$5}'")
              ssh -o StrictHostKeyChecking=no ${ssh_user}@${new_master_host} \
                  "sudo /usr/sbin/ip addr add $VIP dev $IFACE 2>/dev/null || true"
              log "VIP added to $new_master_host"
              
              log "Starting auto-recovery script..."
              log "Command: bash $RECOVERY_SCRIPT $orig_master_host $new_master_host"
              
              sudo systemd-run --unit=mha-auto-recovery \
                  --description="MHA Auto Recovery" \
                  /bin/bash "$RECOVERY_SCRIPT" "$orig_master_host" "$new_master_host" >> "$LOGFILE" 2>&1
              
              log "Auto-recovery script launched"
              exit 0
              ;;
          status)
              exit 0
              ;;
          *)
              log "ERROR: Unknown command: $command"
              exit 1
              ;;
      esac
    dest: /usr/local/bin/master_ip_failover.sh
    owner: root
    group: root
    mode: '0755'

- name: 자동 복구 스크립트 생성 (무한 대기 + 로그 최적화)
  ansible.builtin.copy:
    content: |
      #!/bin/bash
      
      ORIGINAL_MASTER="$1"
      CURRENT_MASTER="$2"
      LOG="/var/log/mha/auto_recovery.log"
      USER="ansible-admin"
      VIP="10.4.4.100/24"
      MYSQL_USER="mha"
      MYSQL_PASS="mhapass"
      
      SSH_OPTS="-i /home/ansible-admin/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=5"
      
      log() {
          echo "$(date '+%Y-%m-%d %H:%M:%S') - $*" | tee -a "$LOG"
      }
      
      if [ -z "$ORIGINAL_MASTER" ] || [ -z "$CURRENT_MASTER" ]; then
          log "ERROR: Missing parameters!"
          exit 1
      fi
      
      log "========================================="
      log "Auto Failback Started"
      log "Original Master: $ORIGINAL_MASTER"
      log "Current Master: $CURRENT_MASTER"
      log "========================================="
      
      sleep 30
      
      log "Step 1: Waiting for original master MySQL (INFINITE)..."
      RETRY=0
      LOG_INTERVAL=120  # 1시간 = 120회 시도 (30초 * 120 = 3600초)
      
      while true; do
          RETRY=$((RETRY+1))
          
          # 처음 10번은 매번 로그, 그 이후는 1시간에 1번만
          if [ $RETRY -le 10 ] || [ $((RETRY % LOG_INTERVAL)) -eq 0 ]; then
              log "Attempt $RETRY - Waiting for $ORIGINAL_MASTER to come back..."
          fi
      
          if mysql -h $ORIGINAL_MASTER -u$MYSQL_USER -p$MYSQL_PASS -e "SELECT 1" >/dev/null 2>&1; then
              log "✓ Original master MySQL is UP after $RETRY attempts!"
              break
          fi
      
          sleep 30
      done
      
      log "Step 2: Configuring original master as slave..."
      mysql -h $ORIGINAL_MASTER -u$MYSQL_USER -p$MYSQL_PASS <<SQLCMD >> "$LOG" 2>&1
      STOP SLAVE;
      RESET SLAVE ALL;
      SET GLOBAL read_only = ON;
      CHANGE MASTER TO
        MASTER_HOST='$CURRENT_MASTER',
        MASTER_USER='repl',
        MASTER_PASSWORD='replpass',
        MASTER_AUTO_POSITION=1;
      START SLAVE;
      SQLCMD
      log "Original master configured as slave"
      
      log "Step 3: Waiting for data sync (30 seconds)..."
      sleep 30
      
      log "Step 4: Checking replication sync..."
      for i in {1..12}; do
          BEHIND=$(mysql -h $ORIGINAL_MASTER -u$MYSQL_USER -p$MYSQL_PASS -e "SHOW SLAVE STATUS\G" 2>/dev/null | grep "Seconds_Behind_Master:" | awk '{print $2}')
      
          if [ "$BEHIND" == "0" ] || [ "$BEHIND" == "NULL" ]; then
              log "Replication synchronized!"
              break
          fi
          log "Sync: $BEHIND seconds behind..."
          sleep 5
      done
      
      log "Step 5: Setting current master to read-only..."
      mysql -h $CURRENT_MASTER -u$MYSQL_USER -p$MYSQL_PASS <<SQLCMD >> "$LOG" 2>&1
      SET GLOBAL read_only = ON;
      FLUSH TABLES WITH READ LOCK;
      SQLCMD
      log "Current master set to read-only"
      
      sleep 2
      
      log "Step 6: Promoting original master back to master..."
      mysql -h $ORIGINAL_MASTER -u$MYSQL_USER -p$MYSQL_PASS <<SQLCMD >> "$LOG" 2>&1
      STOP SLAVE;
      RESET SLAVE ALL;
      SET GLOBAL read_only = OFF;
      SET GLOBAL super_read_only = OFF;
      SQLCMD
      log "Original master promoted"
      
      log "Step 7: Moving VIP..."
      
      log "Removing VIP from $CURRENT_MASTER..."
      IFACE_CURRENT=$(ssh $SSH_OPTS ${USER}@${CURRENT_MASTER} "ip route | awk '/default/ {print \$5}'")
      ssh $SSH_OPTS ${USER}@${CURRENT_MASTER} "sudo /usr/sbin/ip addr del $VIP dev $IFACE_CURRENT 2>/dev/null || true" 2>&1 | tee -a "$LOG"
      log "VIP remove command sent to $CURRENT_MASTER"
      
      sleep 2
      
      log "Adding VIP to $ORIGINAL_MASTER..."
      IFACE_ORIGINAL=$(ssh $SSH_OPTS ${USER}@${ORIGINAL_MASTER} "ip route | awk '/default/ {print \$5}'")
      ssh $SSH_OPTS ${USER}@${ORIGINAL_MASTER} "sudo /usr/sbin/ip addr add $VIP dev $IFACE_ORIGINAL 2>/dev/null || true" 2>&1 | tee -a "$LOG"
      log "VIP add command sent to $ORIGINAL_MASTER"
      
      sleep 2
      
      log "Step 8: Reconfiguring current master as slave..."
      mysql -h $CURRENT_MASTER -u$MYSQL_USER -p$MYSQL_PASS <<SQLCMD >> "$LOG" 2>&1
      UNLOCK TABLES;
      STOP SLAVE;
      RESET SLAVE ALL;
      SET GLOBAL read_only = ON;
      SET GLOBAL super_read_only = ON;
      CHANGE MASTER TO
        MASTER_HOST='$ORIGINAL_MASTER',
        MASTER_USER='repl',
        MASTER_PASSWORD='replpass',
        MASTER_AUTO_POSITION=1;
      START SLAVE;
      SQLCMD
      log "Slave replication configured"
      
      log "Step 9: Cleaning up..."
      rm -f /var/log/mha/app1/app1.failover.* 2>/dev/null || true
      pkill -f masterha_manager 2>/dev/null || true
      sleep 5
      
      log "Step 10: Verifying VIP location..."
      VIP_MASTER=$(ssh $SSH_OPTS ${USER}@${ORIGINAL_MASTER} "ip addr | grep '10.4.4.100'" 2>/dev/null | wc -l)
      VIP_SLAVE=$(ssh $SSH_OPTS ${USER}@${CURRENT_MASTER} "ip addr | grep '10.4.4.100'" 2>/dev/null | wc -l)
      log "VIP check: Master=$VIP_MASTER, Slave=$VIP_SLAVE"
      
      log "Step 11: Restarting MHA Manager..."
      sudo systemctl start mha-manager >> "$LOG" 2>&1
      sleep 10
      
      STATUS=$(masterha_check_status --conf=/etc/mha/app1.cnf 2>&1)
      log "MHA Status: $STATUS"
      
      log "========================================="
      log "AUTO FAILBACK COMPLETED!"
      log "Total wait time: $((RETRY * 30)) seconds"
      log "Master: $ORIGINAL_MASTER"
      log "Slave: $CURRENT_MASTER"
      log "========================================="
    dest: /usr/local/bin/mha_auto_recovery.sh
    owner: root
    group: root
    mode: '0755'

- name: MHA 사전 체크 스크립트 생성
  ansible.builtin.copy:
    content: |
      #!/bin/bash
      LOG="/var/log/mha/precheck.log"
      
      log() {
          echo "$(date '+%Y-%m-%d %H:%M:%S') - $*" >> "$LOG"
      }
      
      log "========================================="
      log "MHA Pre-Start Check"
      log "========================================="
      
      log "Testing MySQL connections..."
      if mysql -h 10.4.4.12 -umha -pmhapass -e "SELECT @@hostname;" >> "$LOG" 2>&1; then
          log "Master (10.4.4.12) OK"
      else
          log "Master (10.4.4.12) FAILED"
          exit 1
      fi
      
      if mysql -h 10.4.4.13 -umha -pmhapass -e "SELECT @@hostname;" >> "$LOG" 2>&1; then
          log "Slave (10.4.4.13) OK"
      else
          log "Slave (10.4.4.13) FAILED"
          exit 1
      fi
      
      log "All pre-checks passed"
    dest: /usr/local/bin/mha_precheck.sh
    owner: root
    group: root
    mode: '0755'

- name: MHA Manager systemd 서비스 생성
  ansible.builtin.copy:
    content: |
      [Unit]
      Description=MHA Manager for MySQL HA
      After=network.target
      
      [Service]
      Type=simple
      User=ansible-admin
      ExecStartPre=/bin/sleep 3
      ExecStartPre=/usr/local/bin/mha_precheck.sh
      ExecStart=/usr/local/bin/masterha_manager --conf=/etc/mha/app1.cnf
      Restart=on-failure
      RestartSec=10
      StandardOutput=append:/var/log/mha/manager.out
      StandardError=append:/var/log/mha/manager.out
      
      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/mha-manager.service
    owner: root
    group: root
    mode: '0644'

- name: systemd 데몬 리로드
  ansible.builtin.systemd:
    daemon_reload: yes

- name: MHA Manager 서비스 활성화
  ansible.builtin.systemd:
    name: mha-manager
    enabled: yes

- name: MySQL 접속 테스트 - Master
  ansible.builtin.shell:
    cmd: mysql -h 10.4.4.12 -umha -pmhapass -e "SELECT @@hostname;"
  register: mysql_master_test
  changed_when: false
  failed_when: mysql_master_test.rc != 0

- name: MySQL 접속 테스트 - Slave
  ansible.builtin.shell:
    cmd: mysql -h 10.4.4.13 -umha -pmhapass -e "SELECT @@hostname;"
  register: mysql_slave_test
  changed_when: false
  failed_when: mysql_slave_test.rc != 0

- name: MySQL 접속 테스트 결과 출력
  ansible.builtin.debug:
    msg: "MySQL 접속 테스트 성공: Master와 Slave 모두 정상"

- name: MHA SSH 체크 실행
  ansible.builtin.shell:
    cmd: masterha_check_ssh --conf=/etc/mha/app1.cnf
  become_user: ansible-admin
  register: mha_ssh_check
  changed_when: false
  failed_when: false

- name: MHA SSH 체크 결과 출력
  ansible.builtin.debug:
    var: mha_ssh_check.stdout_lines

- name: MHA Replication 체크 실행
  ansible.builtin.shell:
    cmd: masterha_check_repl --conf=/etc/mha/app1.cnf
  become_user: ansible-admin
  register: mha_repl_check
  changed_when: false
  failed_when: false

- name: MHA Replication 체크 결과 출력
  ansible.builtin.debug:
    var: mha_repl_check.stdout_lines

- name: MHA Manager 서비스 시작
  ansible.builtin.systemd:
    name: mha-manager
    state: started

- name: MHA Manager 시작 대기
  ansible.builtin.pause:
    seconds: 5

- name: MHA 상태 확인
  ansible.builtin.shell:
    cmd: masterha_check_status --conf=/etc/mha/app1.cnf
  become_user: ansible-admin
  register: mha_status
  changed_when: false
  failed_when: false

- name: MHA 상태 출력
  ansible.builtin.debug:
    var: mha_status.stdout_lines

- name: Manager 설정 완료
  ansible.builtin.debug:
    msg: "==== MHA Manager 서버 설정 완료 ===="
