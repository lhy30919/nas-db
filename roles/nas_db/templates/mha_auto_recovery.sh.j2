#!/bin/bash

ORIGINAL_MASTER="$1"
CURRENT_MASTER="$2"
LOG="/var/log/mha/auto_recovery.log"
USER="ansible-admin"
VIP="10.4.4.100/24"
MYSQL_USER="mha"
MYSQL_PASS="mhapass"

SSH_OPTS="-i /home/ansible-admin/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=5"

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $*" | tee -a "$LOG"
}

if [ -z "$ORIGINAL_MASTER" ] || [ -z "$CURRENT_MASTER" ]; then
    log "ERROR: Missing parameters!"
    exit 1
fi

log "========================================="
log "Auto Failback Started"
log "Original Master: $ORIGINAL_MASTER"
log "Current Master: $CURRENT_MASTER"
log "========================================="

sleep 30

log "Step 1: Waiting for original master to come online (INFINITE)..."
RETRY=0
LOG_INTERVAL=120  # 1시간 = 120회 시도 (30초 * 120 = 3600초)

while true; do
    RETRY=$((RETRY+1))
    
    # 처음 10번은 매번 로그, 그 이후는 1시간에 1번만
    if [ $RETRY -le 10 ] || [ $((RETRY % LOG_INTERVAL)) -eq 0 ]; then
        log "Attempt $RETRY - Waiting for $ORIGINAL_MASTER (ping + MySQL)..."
    fi

    # Ping 체크
    if ping -c 1 -W 2 $ORIGINAL_MASTER >/dev/null 2>&1; then
        # MySQL 체크
        if mysql -h $ORIGINAL_MASTER -u$MYSQL_USER -p$MYSQL_PASS -e "SELECT 1" >/dev/null 2>&1; then
            log "✓ Original master is UP (ping + MySQL OK) after $RETRY attempts!"
            break
        fi
    fi

    sleep 30
done

log "Step 1.5: Cleaning up duplicate VIP..."
# Master가 복귀했을 때 둘 다 VIP가 있을 수 있으므로 확인 후 정리
VIP_ON_ORIGINAL=$(ssh $SSH_OPTS ${USER}@${ORIGINAL_MASTER} "ip addr show | grep '10.4.4.100'" 2>/dev/null | wc -l)
VIP_ON_CURRENT=$(ssh $SSH_OPTS ${USER}@${CURRENT_MASTER} "ip addr show | grep '10.4.4.100'" 2>/dev/null | wc -l)

log "VIP status: Original=$VIP_ON_ORIGINAL, Current=$VIP_ON_CURRENT"

# Original Master에 VIP가 있으면 제거 (아직 Slave로 전환 전)
if [ "$VIP_ON_ORIGINAL" -gt 0 ]; then
    log "Removing VIP from original master $ORIGINAL_MASTER"
    IFACE_ORIGINAL=$(ssh $SSH_OPTS ${USER}@${ORIGINAL_MASTER} "ip route | awk '/default/ {print \$5}'")
    ssh $SSH_OPTS ${USER}@${ORIGINAL_MASTER} "sudo /usr/sbin/ip addr del $VIP dev $IFACE_ORIGINAL 2>/dev/null || true"
    log "VIP removed from $ORIGINAL_MASTER"
fi

log "Step 2: Configuring original master as slave..."
mysql -h $ORIGINAL_MASTER -u$MYSQL_USER -p$MYSQL_PASS <<SQLCMD >> "$LOG" 2>&1
STOP SLAVE;
RESET SLAVE ALL;
SET GLOBAL read_only = ON;
CHANGE MASTER TO
  MASTER_HOST='$CURRENT_MASTER',
  MASTER_USER='repl',
  MASTER_PASSWORD='replpass',
  MASTER_AUTO_POSITION=1;
START SLAVE;
SQLCMD
log "Original master configured as slave"

log "Step 3: Waiting for data sync (30 seconds)..."
sleep 30

log "Step 4: Checking replication sync..."
for i in {1..12}; do
    BEHIND=$(mysql -h $ORIGINAL_MASTER -u$MYSQL_USER -p$MYSQL_PASS -e "SHOW SLAVE STATUS\G" 2>/dev/null | grep "Seconds_Behind_Master:" | awk '{print $2}')

    if [ "$BEHIND" == "0" ] || [ "$BEHIND" == "NULL" ]; then
        log "Replication synchronized!"
        break
    fi
    log "Sync: $BEHIND seconds behind..."
    sleep 5
done

log "Step 5: Setting current master to read-only..."
mysql -h $CURRENT_MASTER -u$MYSQL_USER -p$MYSQL_PASS <<SQLCMD >> "$LOG" 2>&1
SET GLOBAL read_only = ON;
FLUSH TABLES WITH READ LOCK;
SQLCMD
log "Current master set to read-only"

sleep 2

log "Step 6: Promoting original master back to master..."
mysql -h $ORIGINAL_MASTER -u$MYSQL_USER -p$MYSQL_PASS <<SQLCMD >> "$LOG" 2>&1
STOP SLAVE;
RESET SLAVE ALL;
SET GLOBAL read_only = OFF;
SET GLOBAL super_read_only = OFF;
SQLCMD
log "Original master promoted"

log "Step 7: Moving VIP..."

log "Removing VIP from $CURRENT_MASTER..."
IFACE_CURRENT=$(ssh $SSH_OPTS ${USER}@${CURRENT_MASTER} "ip route | awk '/default/ {print \$5}'")
ssh $SSH_OPTS ${USER}@${CURRENT_MASTER} "sudo /usr/sbin/ip addr del $VIP dev $IFACE_CURRENT 2>/dev/null || true" 2>&1 | tee -a "$LOG"
log "VIP remove command sent to $CURRENT_MASTER"

sleep 2

log "Adding VIP to $ORIGINAL_MASTER..."
IFACE_ORIGINAL=$(ssh $SSH_OPTS ${USER}@${ORIGINAL_MASTER} "ip route | awk '/default/ {print \$5}'")
ssh $SSH_OPTS ${USER}@${ORIGINAL_MASTER} "sudo /usr/sbin/ip addr add $VIP dev $IFACE_ORIGINAL 2>/dev/null || true" 2>&1 | tee -a "$LOG"
log "VIP add command sent to $ORIGINAL_MASTER"

sleep 2

log "Step 8: Reconfiguring current master as slave..."
mysql -h $CURRENT_MASTER -u$MYSQL_USER -p$MYSQL_PASS <<SQLCMD >> "$LOG" 2>&1
UNLOCK TABLES;
STOP SLAVE;
RESET SLAVE ALL;
SET GLOBAL read_only = ON;
SET GLOBAL super_read_only = ON;
CHANGE MASTER TO
  MASTER_HOST='$ORIGINAL_MASTER',
  MASTER_USER='repl',
  MASTER_PASSWORD='replpass',
  MASTER_AUTO_POSITION=1;
START SLAVE;
SQLCMD
log "Slave replication configured"

log "Step 9: Cleaning up..."
rm -f /var/log/mha/app1/app1.failover.* 2>/dev/null || true
pkill -f masterha_manager 2>/dev/null || true
sleep 5

log "Step 10: Final VIP verification..."
VIP_MASTER=$(ssh $SSH_OPTS ${USER}@${ORIGINAL_MASTER} "ip addr | grep '10.4.4.100'" 2>/dev/null | wc -l)
VIP_SLAVE=$(ssh $SSH_OPTS ${USER}@${CURRENT_MASTER} "ip addr | grep '10.4.4.100'" 2>/dev/null | wc -l)
log "Final VIP check: Master=$VIP_MASTER, Slave=$VIP_SLAVE"

if [ "$VIP_MASTER" -eq 0 ] || [ "$VIP_SLAVE" -gt 0 ]; then
    log "WARNING: VIP not correctly placed! Fixing..."
    ssh $SSH_OPTS ${USER}@${CURRENT_MASTER} "sudo /usr/sbin/ip addr del $VIP dev $IFACE_CURRENT 2>/dev/null || true"
    ssh $SSH_OPTS ${USER}@${ORIGINAL_MASTER} "sudo /usr/sbin/ip addr add $VIP dev $IFACE_ORIGINAL 2>/dev/null || true"
    log "VIP placement corrected"
fi

log "Step 11: Restarting MHA Manager..."
sudo systemctl start mha-manager >> "$LOG" 2>&1
sleep 10

STATUS=$(masterha_check_status --conf=/etc/mha/app1.cnf 2>&1)
log "MHA Status: $STATUS"

log "========================================="
log "AUTO FAILBACK COMPLETED!"
log "Total wait time: $((RETRY * 30)) seconds"
log "Master: $ORIGINAL_MASTER"
log "Slave: $CURRENT_MASTER"
log "========================================="
